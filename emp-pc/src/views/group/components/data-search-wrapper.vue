<style lang="less">    @import '../../../libs/skin/jeDate.css';    .search-condition{        display: inline-block;    }    .modal-btns{        display: inline-block;        position: relative;        float: right;        .special{            position: absolute;            top:-16px;            right:10px;            color: #c0f9f9;            cursor: pointer;            span{                margin-left: 20px;            }        }    }    .jeinpbox{        width: 300px;        height: 32px;        display: inline-block;        #timeNow{            border: 1px solid #dddee1;            padding:0 10px;            border-radius: 4px;            -webkit-box-sizing: border-box;            -moz-box-sizing: border-box;            box-sizing: border-box;            width: 100%;            height: 100%;        }    }</style><template>    <div class="data-search">        <div class="search-condition">            <Select                    clearable                    style="width:200px"                    placeholder="请输入搜索设备名称或SN号"                    v-model="choosedSn"                    filterable                    remote                    @on-query-change="setQuery"                    :remote-method="remoteMethod"                    :loading="loading">                <Option v-for="(option, index) in deviceList" :label="option.deviceName" :value="option.sn" :key="option.sn">{{option.deviceName}}</Option>            </Select>            <div class="jeinpbox"><input type="text" @focus="getTime" class="jeinput" id="timeNow" placeholder="请选择起始时间"></div>            <Button type="primary" @click="searchAll(0)">{{lang.search}}</Button>        </div>        <div class="modal-btns">            <div class="special">                <span @click="delSpecialModal">-</span>                <span @click="editSpecial">#</span>            </div>            <Table v-show="false" ref="tableRef" :columns="columnsTable" :data="dataAll"></Table>            <Table v-show="false" ref="tableAlarm" :columns="columnsAlarm" :data="dataAll"></Table>            <Button :type="self" @click="chooseMy">{{lang.myDevice}}</Button>            <Button :type="share" @click="shareTheModal">{{shareAccount}}</Button>            <Button  v-show="outExcel" @click="exportData">{{lang.outExcel}}</Button>        </div>        <!--历史记录-->        <Modal v-model="editSpecialSelect" title="编辑" :mask-closable="false">            <div>                <Form ref="formValidateSpecial"  :model="formValidateSpecial" :rules="ruleValidateSpecial" label-position="right" :label-width="100">                    <FormItem label="温度：" prop="specialTem">                        <Input v-model="formValidateSpecial.specialTem"  placeholder="输入温度" style="width: 300px"></Input>                    </FormItem>                    <FormItem label="湿度：" prop="specialHum">                        <Input v-model="formValidateSpecial.specialHum"  placeholder="输入湿度" style="width: 300px"></Input>                    </FormItem>                    <FormItem label="时间：" prop="specialTim">                        <Input v-model="formValidateSpecial.specialTim"  placeholder="输入时间" style="width: 300px"></Input>                    </FormItem>                </Form>            </div>            <div slot="footer">                <Button @click="comfirmSpecial('formValidateSpecial')" type="primary" >确定</Button>            </div>        </Modal>        <Modal v-model="delSpecialSelect" title="删除" >            <div>确认删除此条记录？</div>            <div slot="footer">                <Button @click="comfirmDelSpecial" type="primary" >确定</Button>            </div>        </Modal>        <!--预警-->        <Modal v-model="editSpecialSelectw" title="预警编辑" :mask-closable="false">            <div>                <Form ref="formValidateSpecialw"  :model="formValidateSpecialw" :rules="ruleValidateSpecialw" label-position="right" :label-width="100">                    <FormItem label="预警值：" prop="specialWrData">                        <Input v-model="formValidateSpecialw.specialWrData"  placeholder="输入预警值" style="width: 300px"></Input>                    </FormItem>                    <FormItem label="预警内容：" prop="specialContent">                        <Input v-model="formValidateSpecialw.specialContent"  placeholder="输入预警内容" style="width: 300px"></Input>                    </FormItem>                </Form>            </div>            <div slot="footer">                <Button @click="comfirmSpecialw('formValidateSpecialw')" type="primary" >确定</Button>            </div>        </Modal>        <!--<Modal v-model="delSpecialSelectw" title="删除" >-->            <!--<div>确认删除当前设备？</div>-->            <!--<div slot="footer">-->                <!--<Button @click="comfirmDelSpecial" type="primary" >确定</Button>-->            <!--</div>-->        <!--</Modal>-->        <Modal v-model="shareModal" :title="lang.shareMyDevie" :mask-closable="false">            <div>                <div>                    <Input v-model="sharedAccount"  :placeholder="lang.inDeviceName" style="width: 300px"></Input>                    <Button type="primary" @click="searchShareToMedevice">{{lang.search}}</Button>                </div>                <div style="margin-top: 10px;">                    <Table highlight-row :columns="accountColumns" :data="accountList" @on-selection-change="selectIt" ></Table>                </div>            </div>            <div slot="footer">                <Button @click="chooseAccount()" type="primary" >{{lang.choose}}</Button>            </div>        </Modal>    </div></template><script>    // import jeDate from "../../../libs/src/jedate";    export default{      name:'dataSearch',      computed: {        lang(){          return this.$store.state.lang.btns        }      },      props:["tabName",'tableListPage','recordListPage','special'],      watch:{        shareModal(newVal,oldVal){          if(newVal){            this.searchShareToMedevice()          }else{            if(this.choosedShareAccount.sharedUserId != null){              this.shareAccount = this.choosedShareAccount.sharedAccount+"分享给我的设备"              this.self = 'default';              this.share = 'primary';            }else{              this.shareAccount = "分享给我的设备"              this.self = 'primary';              this.share = 'default';            }          }        },        recordListPage(newVal,oldVal){          this.selectWarningRecord(newVal)        },        tableListPage(newVal,oldVal) {          if (this.tabName == 'name1') {            this.searchList(newVal)          } else if (this.tabName == 'name2') {            this.searchChart(newVal)          } else {            this.selectWarningRecord(newVal)          }        }      },      data(){        const canNoBeEmpty = (rule, value, callback) => {          if (value === ''||value === undefined) {            callback(new Error('该项不能为空'));          } else {            callback();          }        };        return {          outExcel:true,          editSpecialSelectw:false,          formValidateSpecialw:{            specialWrData:'',            specialContent:'',          },          ruleValidateSpecialw:{            specialWrData: [              { required: true, validator: canNoBeEmpty,  trigger: 'change' }            ],            specialContent: [              { required: true, validator: canNoBeEmpty,  trigger: 'change' }            ]          },          delSpecialSelect:false,          delSpecialSelectw:false,          editSpecialSelect:false,          formValidateSpecial:{            specialTem:'',            specialHum:'',            specialTim:''          },          ruleValidateSpecial:{            specialTem: [              { required: true, validator: canNoBeEmpty,  trigger: 'change' }            ],            specialHum: [              { required: true, validator: canNoBeEmpty,  trigger: 'change' }            ],            specialTim: [              { required: true, validator: canNoBeEmpty,  trigger: 'change' }            ]          },          dataAll:[],          self:'primary',          share:'default',          choosedSn:'',          searchQuery:'',          choosedTheDate:[],          loading:false,          shareAccount:'分享给我的设备',          choosedShareAccount:{            sharedUserId:null          },          sharedAccount:'',          shareModal:false,          accountList: [],          columnsTable: [            // {title: '设备名称', key: 'deviceName'},//            {title: '设备SN', key: 'sn'},            {title: '温度', key: 'temperature'},            {title: '湿度', key: 'humidity'},            {title: '记录时间', key: 'date'},          ],          columnsAlarm:[            // {title: '设备名称', key: 'deviceName'},//            {title: '设备SN', key: 'sn'},            {title: '报警内容', key: 'content'},            {title: '短信通知', key: 'isSms'},            {title: '邮件通知', key: 'isEmail'},            {title: '记录时间', key: 'date'}          ],          accountColumns: [            {              type: 'selection',              width: 60,              align: 'center',              key_checked:'checked'            },            {              title: '账号',              key: 'sharedAccount'            },            {              title: '设备参数',              key: 'deviceCount'            }          ],          deviceList:[],        }      },      mounted(){        if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){          this.selectWarningRecord(0);        }        if(this.tabName == 'name2'&&this.$route.name=='history-data'){          this.outExcel = false;        }      },      methods:{        setQuery(it){          this.searchQuery = it;        },        comfirmSpecialw(name){          this.$refs[name].validate((valid) => {            if (valid) {              let userId = this.$cookie.get('userId');              let accessToken = this.$cookie.get('accessToken');              let permissions = this.$cookie.get('permissions');              let data = {                id:this.special.id,                sn:this.special.sn,                wrData:this.formValidateSpecialw.specialWrData*1,                content:this.formValidateSpecialw.specialContent,                date:this.special.date,                userId:userId,                loginType:2,                accessToken:accessToken,                permissions:permissions              };              this.$http({                method:'post',                url:this.$util.ajaxUrl+"/warning/updateWarningData",                data              },(res)=>{                let result = res.data;                if(result.code==0){                  this.$Message.success('编辑成功!');                  this.editSpecialSelectw = false;                  this.searchAll(0)                }else{                  this.$Message.error(res.data.msg)                };              },(erro)=>{                console.log(erro);              })            }          })        },        comfirmSpecial(name){          this.$refs[name].validate((valid) => {            if (valid) {              let userId = this.$cookie.get('userId');              let accessToken = this.$cookie.get('accessToken');              let permissions = this.$cookie.get('permissions');              let data = {                id:this.special.id,                sn:this.special.sn,                temperature:this.formValidateSpecial.specialTem*1,                humidity:this.formValidateSpecial.specialHum*1,                date:this.formValidateSpecial.specialTim,                userId:userId,                loginType:2,                accessToken:accessToken,                permissions:permissions              };              this.$http({                method:'post',                url:this.$util.ajaxUrl+"/historical/updateHistoryData",                data              },(res)=>{                let result = res.data;                if(result.code==0){                  this.$Message.success('编辑成功!');                  this.editSpecialSelect = false;                  this.searchAll(0)                }else{                  this.$Message.error(res.data.msg)                }              },(erro)=>{                console.log(erro);              })            }          })        },        editSpecial(){          if(this.special.id!=undefined){            if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){              this.editSpecialSelectw = true;              this.formValidateSpecialw = {                specialWrData:this.special.wrData,                specialContent:this.special.content,              }            }else{              this.editSpecialSelect = true;              this.formValidateSpecial = {                specialTem:this.special.temperature,                specialHum:this.special.humidity,                specialTim:this.special.date              }            }          }        },        //删除预警记录        delWarmingRecord(){          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            id:this.special.id,            sn:this.special.sn,            wrData:this.special.wrData,            content:this.special.content,            date:this.special.date,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/deleteWarningData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.delSpecialSelect = false;              this.$Message.success('删除成功')              this.selectWarningRecord(0)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        comfirmDelSpecial(){          if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.delWarmingRecord()          }else{            this.delSpecial()          }        },        delSpecialModal(){          if(this.special.id!=undefined){            this.delSpecialSelect = true;          }        },        //删除历史记录        delSpecial(){          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            id:this.special.id,            sn:this.special.sn,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          var url='';          if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            url= this.$util.ajaxUrl+"/warning/deleteWarningData"          }else{            url= this.$util.ajaxUrl+"/historical/deleteHistoryData"          };          this.$http({            method:'post',            url,            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.delSpecialSelect = false;             this.searchAll(0)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        shareTheModal(){          this.deviceList = [];          this.shareModal = true;        },        //选中时间        getTime(){          const _this = this;          jeDate("#timeNow",{            isinitVal:true,            format: 'YYYY-MM-DD hh:mm:ss',            initDate:[{hh:10,mm:10,ss:10},false],            multiPane:false,            range:" 至 ",            donefun:function(obj){              _this.choosedTheDate = obj.date;              console.log(obj.date)            },            clearfun:function(elem, val){              this.choosedTheDate = [];              _this.choosedTheDate = {}            }          });        },        searchAll(page){          this.$emit('initPage',page)          if(this.$route.name=='history-data'||this.$route.name=='history-data-1'){            if(this.tabName=='name1'){              this.searchList(0)            }else if(this.tabName=='name2'){              this.searchChart()            }          }else if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.selectWarningRecord(0)          }        },        /*搜索预警记录*/        selectWarningRecord(page){          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = '';          let endTime = '';          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          };          let data = {            rows:15,            page:page,            sn: this.choosedSn,            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/selectWarningData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.$emit('getList',result.data)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*搜索图表*/        searchChart(){          if(this.choosedSn==''){            this.$Message.error('请先选择设备')            return          };          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = '';          let endTime = '';          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          };          let data = {            sn: this.choosedSn,            deviceName:'',            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/historical/historyCurveData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.$emit('getList',result.data)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*搜索表格列表*/        searchList(page){          if(this.choosedSn==''){            this.$Message.error('请先选择设备')            return          };          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = ''          let endTime = ''          if(this.choosedTheDate.length>0){             endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss             startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          }          let data = {            rows:15,            page:page,            sn: this.choosedSn,            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/historical/selectHistoryData",            data          },(res)=>{            let result = res.data;            if(result.code==0){                this.$emit('getList',result.data)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*选中’我的设备‘按钮*/        chooseMy(){          this.deviceList = [];          this.choosedSn = '';          this.self = 'primary';          this.share = 'default';          this.choosedShareAccount = {            sharedUserId:null          };          this.shareAccount = "分享给我的设备";          if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.selectWarningRecord(0)          };          this.remoteMethod(this.searchQuery)        },        /*选择账户*/        chooseAccount(){          this.choosedSn = '';         if(this.choosedShareAccount.sharedUserId!=null){           this.shareModal = false;           this.shareAccount = this.choosedShareAccount.sharedAccount+"分享给我的设备"           this.share = 'primary';           this.self = 'default';         }else{           this.shareAccount = "分享给我的设备"           this.shareModal = false;           this.self = 'primary';           this.share = 'default';         };          if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.selectWarningRecord(0)          }         this.remoteMethod(this.searchQuery)()        },        /*选中表格*/        selectIt(it){          if(it.length!=0){            this.choosedShareAccount = it[0]          }else{            this.choosedShareAccount = {              sharedUserId:null            };            this.shareAccount = "分享给我的设备"          }        },        /*搜索分享给我的设备*/        searchShareToMedevice(){          let _this = this;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            rows:10,            page:0,            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/shared/selectSharedForMe",            data          },(res)=>{            let result = res.data;            if(result.code==0){                this.accountList = result.data.dataList;                if(this.accountList.length==0){                  this.$Message.error("暂无数据")                  return                }                this.accountList.forEach(function(val,index){                    if(val.sharedUserId == _this.choosedShareAccount.sharedUserId){                      val._checked = true                    }else{                      val._checked = false                    }                })            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*查询设备远程*/        remoteMethod(searchQuery){          this.deviceList = [];          this.loading = true;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            deviceName:searchQuery,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/getDevices",            data          },(res)=>{            let result = res.data;            if(result.code==0){                this.deviceList = [...result.data];                console.log(this.deviceList)                this.loading = false;            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },         getNowFormatDate() {          var date = new Date();          var seperator1 = "-";          var seperator2 = ":";          var month = date.getMonth() + 1;          var strDate = date.getDate();          if (month >= 1 && month <= 9) {            month = "0" + month;          }          if (strDate >= 0 && strDate <= 9) {            strDate = "0" + strDate;          }          var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate            + " " + date.getHours() + seperator2 + date.getMinutes()            + seperator2 + date.getSeconds();          return currentdate;        },        exportHistoryData(){          const _this = this;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = '';          let endTime = '';          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          };          window.open('http://yun.huahanw.com//public/downLoadExcel?' +            'sn=' +this.choosedSn+ '&' +'startTime=' +startTime+ '&' +'endTime=' +endTime+'&' +'userId=' +userId+            '&' +'loginType=2' +'&' +'accessToken=' +accessToken+'&' + 'permissions=' +permissions+'&' +'type=1')        },        exportRecordData(){          const _this = this;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = ''          let endTime = ''          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          }          window.open('http://yun.huahanw.com//public/downLoadExcel?' +            'sn=' +this.choosedSn+ '&' +'startTime=' +startTime+ '&' +'endTime=' +endTime+'&' +'userId=' +userId+            '&' +'loginType=2' +'&' +'accessToken=' +accessToken+'&' + 'permissions=' +permissions+'&' +'type=2')        },        exportData(){          if(this.choosedSn==''){            this.$Message.error('请先选择设备')            return          };          if(this.$route.name=='history-data'){            this.exportHistoryData()          }else if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.exportRecordData()          }        }      }    }</script>