<style lang="less">    @import '../../../libs/skin/jeDate.css';    .search-condition{        display: inline-block;    }    .modal-btns{        display: inline-block;        float: right;    }    .jeinpbox{        width: 300px;        height: 32px;        display: inline-block;        #timeNow{            border: 1px solid #dddee1;            padding:0 10px;            border-radius: 4px;            -webkit-box-sizing: border-box;            -moz-box-sizing: border-box;            box-sizing: border-box;            width: 100%;            height: 100%;        }    }</style><template>    <div class="data-search">        <div class="search-condition">            <Select                    clearable                    style="width:200px"                    placeholder="请输入搜索设备名称"                    v-model="choosedSn"                    @on-change="selectDevice"                    @on-query-change="inText"                    filterable                    remote                    @on-open-change="remoteMethodList"                    :remote-method="remoteMethod"                    :loading="loading">                <Option v-for="(option, index) in deviceList" :label="option.deviceName" :value="option.sn" :key="option.sn">{{option.deviceName}}</Option>            </Select>            <div class="jeinpbox"><input type="text" @focus="getTime" class="jeinput" id="timeNow" placeholder="请选择起始时间"></div>            <Button type="primary" @click="searchAll(0)">{{lang.search}}</Button>        </div>        <div class="modal-btns">            <Table v-show="false" ref="tableRef" :columns="columnsTable" :data="dataAll"></Table>            <Table v-show="false" ref="tableAlarm" :columns="columnsAlarm" :data="dataAll"></Table>            <Button :type="self" @click="chooseMy">{{lang.myDevice}}</Button>            <Button :type="share" @click="shareTheModal">{{shareAccount}}</Button>            <Button @click="exportData">{{lang.outExcel}}</Button>        </div>        <Modal v-model="shareModal" :title="lang.shareMyDevie" :mask-closable="false">            <div>                <div>                    <Input v-model="sharedAccount"  :placeholder="lang.inDeviceName" style="width: 300px"></Input>                    <Button type="primary" @click="searchShareToMedevice">{{lang.search}}</Button>                </div>                <div style="margin-top: 10px;">                    <Table highlight-row :columns="accountColumns" :data="accountList" @on-selection-change="selectIt" ></Table>                </div>            </div>            <div slot="footer">                <Button @click="chooseAccount()" type="primary" >{{lang.choose}}</Button>            </div>        </Modal>    </div></template><script>    import jeDate from "../../../libs/jedate.min"    export default{      name:'dataSearch',      computed: {        lang(){          return this.$store.state.lang.btns        }      },      props:["tabName",'tableListPage','recordListPage'],      watch:{        shareModal(newVal,oldVal){          if(newVal){            this.searchShareToMedevice()          }else{            if(this.choosedShareAccount.sharedUserId != null){              this.shareAccount = this.choosedShareAccount.sharedAccount+"分享给我的设备"              this.self = 'default';              this.share = 'primary';            }else{              this.shareAccount = "分享给我的设备"              this.self = 'primary';              this.share = 'default';            }          }        },        recordListPage(newVal,oldVal){          this.selectWarningRecord(newVal)        },        tableListPage(newVal,oldVal) {          if (this.tabName == 'name1') {            this.searchList(newVal)          } else if (this.tabName == 'name2') {            this.searchChart(newVal)          } else {            this.selectWarningRecord(newVal)          }        }      },      data(){        return {          dataAll:[],          self:'primary',          share:'default',          choosedSn:'',          searchQuery:'',          choosedTheDate:[],          loading:false,          shareAccount:'分享给我的设备',          choosedShareAccount:{            sharedUserId:null          },          sharedAccount:'',          shareModal:false,          accountList: [],          columnsTable: [            {title: '设备名称', key: 'deviceName'},            {title: '设备SN', key: 'sn'},            {title: '温度', key: 'temperature'},            {title: '湿度', key: 'humidity'},            {title: '记录时间', key: 'date'},          ],          columnsAlarm:[            {title: '设备名称', key: 'deviceName'},            {title: '设备SN', key: 'sn'},            {title: '报警内容', key: 'content'},            {title: '短信通知', key: 'isSms'},            {title: '邮件通知', key: 'isEmail'},            {title: '记录时间', key: 'date'}          ],          accountColumns: [            {              type: 'selection',              width: 60,              align: 'center',              key_checked:'checked'            },            {              title: '账号',              key: 'sharedAccount'            },            {              title: '设备参数',              key: 'deviceCount'            }          ],          deviceList:[],        }      },      mounted(){        // this.remoteMethodList()        if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){          this.selectWarningRecord(0)        }      },      methods:{        /*选中设备*/        selectDevice(it){          this.choosedSn = it        },        inText(it){          this.searchQuery = it        },        shareTheModal(){          this.shareModal = true;        },        //选中时间        getTime(){          const _this = this;          jeDate("#timeNow",{            format: "YYYY-MM-DD hh:mm:ss",            multiPane:false,            range:" 至 ",            donefun:function(obj){              _this.choosedTheDate = obj.date            },            clearfun:function(elem, val){              this.choosedTheDate = [];              _this.choosedTheDate = {}            }          });        },        searchAll(page){          this.$emit('initPage',page)          if(this.$route.name=='history-data'||this.$route.name=='history-data-1'){            if(this.tabName=='name1'){              this.searchList(0)            }else if(this.tabName=='name2'){              this.searchChart()            }          }else if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.selectWarningRecord(0)          }        },        /*搜索预警记录*/        selectWarningRecord(page){          // console.log(this.choosedShareAccount)          // if(this.choosedSn==''){          //   this.$Message.error('请先选择设备')          //   return          // };          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = '';          let endTime = '';          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          };          let data = {            rows:15,            page:page,            sn: this.choosedSn,            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/selectWarningData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.$emit('getList',result.data)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*搜索图表*/        searchChart(){          if(this.choosedSn==''){            this.$Message.error('请先选择设备')            return          };          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = '';          let endTime = '';          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          };          let data = {            sn: this.choosedSn,            deviceName:'',            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/historical/historyCurveData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.$emit('getList',result.data)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*搜索表格列表*/        searchList(page){          if(this.choosedSn==''){            this.$Message.error('请先选择设备')            return          };          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = ''          let endTime = ''          if(this.choosedTheDate.length>0){             endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss             startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          }          let data = {            rows:15,            page:page,            sn: this.choosedSn,            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/historical/selectHistoryData",            data          },(res)=>{            let result = res.data;            if(result.code==0){                this.$emit('getList',result.data)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*选中’我的设备‘按钮*/        chooseMy(){          this.searchQuery = '';          this.choosedSn = '';          this.self = 'primary';          this.share = 'default';          this.choosedShareAccount = {            sharedUserId:null          };          this.shareAccount = "分享给我的设备";          // this.remoteMethodList();          if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.selectWarningRecord(0)          };        },        /*选择账户*/        chooseAccount(){          this.choosedSn = '';          this.searchQuery = '';         if(this.choosedShareAccount.sharedUserId!=null){           this.shareModal = false;           this.shareAccount = this.choosedShareAccount.sharedAccount+"分享给我的设备"           this.share = 'primary';           this.self = 'default';         }else{           this.shareAccount = "分享给我的设备"           this.shareModal = false;           this.self = 'primary';           this.share = 'default';         };         // this.remoteMethodList();          if(this.$route.name=='recorde'||this.$route.name=='recorde-1'){            this.selectWarningRecord(0)          }        },        /*选中表格*/        selectIt(it){          if(it.length!=0){            this.choosedShareAccount = it[0]          }else{            this.choosedShareAccount = {              sharedUserId:null            };            this.shareAccount = "分享给我的设备"          }        },        /*搜索分享给我的设备*/        searchShareToMedevice(){          let _this = this;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            rows:10,            page:0,            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/shared/selectSharedForMe",            data          },(res)=>{            let result = res.data;            if(result.code==0){                this.accountList = result.data.dataList;                if(this.accountList.length==0){                  this.$Message.error("暂无数据")                  return                }                this.accountList.forEach(function(val,index){                    if(val.sharedUserId == _this.choosedShareAccount.sharedUserId){                      val._checked = true                    }else{                      val._checked = false                    }                })            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*查询设备远程列表*/        remoteMethodList(){          this.deviceList = [];          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/getDevices",            data          },(res)=>{            let result = res.data;            const _this = this;            if(result.code==0){              this.deviceList = [...result.data];              // result.data.forEach(function(val,index){              //   _this.deviceList.push(val)              // })              console.log(this.deviceList)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        /*查询设备远程*/        remoteMethod(){          this.deviceList = [];          this.loading = true;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          let data = {            sharedUserId:this.choosedShareAccount.sharedUserId!=null?this.choosedShareAccount.sharedUserId:null,            deviceName:this.searchQuery,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/getDevices",            data          },(res)=>{            let result = res.data;            if(result.code==0){                this.deviceList = [...result.data];                this.loading = false;            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        exportHistoryData(){          const _this = this;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = ''          let endTime = ''          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          }          let data = {            rows:100000,            page:0,            sn: this.choosedSn,            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/historical/selectHistoryData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.dataAll = result.data.dataList              setTimeout(function(){                _this.$refs.tableRef.exportCsv({                  filename: '历史数据'                })              },2000)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        exportRecordData(){          const _this = this;          let userId = this.$cookie.get('userId');          let accessToken = this.$cookie.get('accessToken');          let permissions = this.$cookie.get('permissions');          /*处理时间*/          let startTime = ''          let endTime = ''          if(this.choosedTheDate.length>0){            endTime = this.choosedTheDate[1].YYYY+'-'+this.choosedTheDate[1].MM+'-'+this.choosedTheDate[1].DD+ ' '+this.choosedTheDate[1].hh+':'+this.choosedTheDate[1].mm+':'+this.choosedTheDate[1].ss            startTime = this.choosedTheDate[0].YYYY+'-'+this.choosedTheDate[0].MM+'-'+this.choosedTheDate[0].DD+' '+this.choosedTheDate[0].hh+':'+this.choosedTheDate[0].mm+':'+this.choosedTheDate[0].ss          }          let data = {            rows:100000,            page:0,            sn: this.choosedSn,            startTime:startTime,            endTime:endTime,            userId:userId,            loginType:2,            accessToken:accessToken,            permissions:permissions          };          this.$http({            method:'post',            url:this.$util.ajaxUrl+"/warning/selectWarningData",            data          },(res)=>{            let result = res.data;            if(result.code==0){              this.dataAll = result.data.dataList              setTimeout(function(){                _this.$refs.tableAlarm.exportCsv({                  filename: '报警记录'                })              },2000)            }else{              this.$Message.error(res.data.msg)            }          },(erro)=>{            console.log(erro);          })        },        exportData(){          if(this.choosedSn==''){            this.$Message.error('请先选择设备')            return          };          if(this.$route.name=='history-data'){            this.exportHistoryData()          }else if(this.$route.name=='recorde'){            this.exportRecordData()          }        }      }    }</script>