<style lang="less">    .user-table{        margin-top: 20px;    }    .table-list{        margin-top: 10px;    }    .pages{        margin-top: 10px;        text-align: right;    }    .modal-device{        .ivu-modal{            width: 50%!important;            min-width: 600px;        }    }</style><!--用户分配--><template>    <div class="share">        <div>            <Button type="primary" @click="addUserModal=true">{{lang.add}}</Button>        </div>        <div class="user-table">            <Table border ref="selection" :columns="userColumns" :data="userList"></Table>            <div class="pages">                <Page :total="userListPage" :page-size="15" :current = "userListPageNow+1"  @on-change="userListChange"></Page>            </div>        </div>        <!--查询区域-->        <Modal v-model="deviceAreaModal" :title="lang.chooseArea" :mask-closable="false" >            <div class="regional-list">                <Tree :data="allAreaList" @on-select-change="chooseToTheArea"></Tree>            </div>            <div slot="footer">                <Button @click="confirmChooseArea" type="primary" >{{lang.comfirm}}</Button>            </div>        </Modal>        <!--添加账号-->        <Modal                v-model="addUserModal"                :title="lang.addAccount">           <div>               <Form ref="formInline" :model="formInline" :rules="ruleInline"  :label-width="100">                   <FormItem :label="lang.account" prop="account">                       <Input type="text" v-model="formInline.account" :placeholder="lang.inAccount"></Input>                   </FormItem>                   <FormItem :label="lang.name" prop="userName">                       <Input type="text" v-model="formInline.userName" :placeholder="lang.inName"></Input>                   </FormItem>                   <FormItem :label="lang.password" prop="psd">                       <Input type="text" v-model="formInline.psd" :placeholder="lang.inPassword"></Input>                   </FormItem>                   <FormItem :label="lang.repeatPassword" prop="rePsd">                       <Input type="text" v-model="formInline.rePsd" :placeholder="lang.repeatPassword"></Input>                   </FormItem>               </Form>           </div>            <div slot="footer">                <Button type="primary" @click="comfirmAdd('formInline')">{{lang.comfirm}}</Button>            </div>        </Modal>        <Modal v-model="shareDeviceModal" :title="lang.distribEquipment" class="modal-device">            <div>                <div>                    <Button @click="getDeviceArea">{{deviceArea}}</Button>                    <Input v-model="deviceName" :placeholder="lang.inDeviceAccount" style="width: 300px"></Input>                    <Button type="primary" @click="queryShareMeDevice(0)">{{lang.search}}</Button>                </div>                <div  class="table-list">                    <Table :columns="deviceListColumns" :data="deviceList"></Table>                    <div class="pages">                        <Page :total="deviceListPage" :page-size="10" :current = "deviceListPageNow+1"  @on-change="deviceListPageChange"></Page>                    </div>                </div>            </div>            <div slot="footer"></div>        </Modal>        <Modal :title="theOperate==0?lang.confirmReset: lang.comfirmDelete" v-model="confirmModal"  :mask-closable="true">            <p>{{theOperate==0?lang.confirmReset: lang.comfirmDelete}}？</p>            <div slot="footer">                <Button type="primary" @click="comfirmOperate">{{lang.comfirm}}</Button>            </div>        </Modal>    </div></template><script>  export default {    name: 'user-share',    data(){      const validateAccount = (rule, value, callback) => {        var reg = /^(?![^a-zA-Z]+$)(?!\D+$)/;        var reg1 = /^[a-zA-Z]+$/;        var reg2 = /^[0-9]*$/;        if (value === '') {          callback(new Error('账号输入不能为空'));        } else {          if (reg.test(value)||reg1.test(value)||reg2.test(value)) {            callback();          }else{            callback(new Error('账号可以为字母或数字或字母数字组成'));          }        }      };      const validatePsd = (rule, value, callback) => {        var reg = /^[0-9a-zA-Z]{6,}$/;        if (value === '') {          callback(new Error('密码不能为空'));        } else {          if (reg.test(value)) {            callback();          }else{            callback(new Error('密码为字母和数字组成，至少6位'));          }        }      };      const validatePassf = (rule, value, callback) => {        if (value === '') {          callback(new Error('请再次输入密码'));        } else {          if (this.formInline.psd != value) {            callback(new Error('两次密码输入不一致'));          }else{            callback();          }        }      };      return {        userListPage:0,        userListPageNow:0,        deviceListPage:0,        deviceListPageNow:0,        deviceArea:'选择区域',        deviceAreaModal:false,        deviceName:'',        deviceList: [],        deviceListColumns: [          {            title: '设备名称',            key: 'deviceName',            minWidth:100          },          {            title: '设备SN号',            key: 'sn',            minWidth:100          },          {            title: '所属区域',            key: 'regionalName',            minWidth:100          },          {            title: '状态',            key: 'isShard',            minWidth:100          },          {title: '操作', key: 'action', fixed: 'right', minWidth: 100,            render: (h, params) => {              return h('div', [                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    display: params.row.isShard=="0" ?'none':'block',                    color: '#2d8cf0'                  },                  on: {                    click: () => {                        this.delAssignDevices(params.row)                    }                  }                }, '删除'),                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    display: params.row.isShard=="1"?'none':'block',                    color: '#2d8cf0'                  },                  on: {                    click: () => {                        this.assignDevices(params.row)                    }                  }                }, '分配')              ]);            }          }        ],        formInline:{          userName:'',          account:'',          psd:'',          rePsd:''        },        ruleInline:{          userName:[            { required: true, message: '用户名不能为空', trigger: 'blur' }            ],          account:[            { required: true, validator: validateAccount, trigger: 'blur' }          ],          psd:[            {  required: true,validator: validatePsd, trigger: 'blur' }          ],          rePsd:[            {  required: true,validator: validatePassf, trigger: 'blur' }          ]        },        addUserModal:false,        shareDeviceModal:false,        confirmModal:false,        userColumns:[],        userColumns1: [          {title: '名称', key: 'name',width:400},          {title: '账号', key: 'account',width:300},          {title: '操作', key: 'action', fixed: 'right',            render: (h, params) => {              return h('div', [                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    color: '#2d8cf0'                  },                  on: {                    click: () => {                      this.operateUserInfo = params.row;                      this.theOperate = 0;                      this.confirmModal = true;                    }                  }                }, '重置密码'),                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    color: '#2d8cf0'                  },                  on: {                    click: () => {                      this.operateUserInfo = params.row                     this.confirmModal = true;                      this.theOperate = 1;                    }                  }                }, '删除'),                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    color: '#2d8cf0'                  },                  on: {                    click: () => {                      this.operateUserInfo = params.row                      this.shareDevice(params.index)                    }                  }                }, '分配设备')              ]);            }          }        ],        userColumns2: [          {title: 'name', key: 'name',width:400},          {title: 'account', key: 'account',width:300},          {title: 'operation', key: 'action', fixed: 'right',            render: (h, params) => {              return h('div', [                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    color: '#2d8cf0'                  },                  on: {                    click: () => {                      this.operateUserInfo = params.row;                      this.theOperate = 0;                      this.confirmModal = true;                    }                  }                }, 'resetPassword'),                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    color: '#2d8cf0'                  },                  on: {                    click: () => {                      this.operateUserInfo = params.row                      this.confirmModal = true;                      this.theOperate = 1;                    }                  }                }, 'delete'),                h('Button', {                  props: {type: 'text', size: 'small'},                  style: {                    color: '#2d8cf0'                  },                  on: {                    click: () => {                      this.operateUserInfo = params.row                      this.shareDevice(params.index)                    }                  }                }, 'distributionEquipment')              ]);            }          }        ],        userList: [],        operateUserInfo:{},        theOperate:0,        allAreaListTemp:[],        allAreaList:[],        choosedArea:{},        choosedAreaTemp:{}      }    },    mounted(){      this.selectUserAssigned(0)    },    computed: {      lang(){        if(this.$store.state.lang.is=='cn'){          this.userColumns = this.userColumns1        }else{          this.userColumns = this.userColumns2        }        return this.$store.state.lang.userShare      }    },    watch:{      deviceAreaModal(newVal,oldVal){        newVal?this.shareDeviceModal = false:this.shareDeviceModal = true;        if(this.choosedArea.title){          this.deviceArea = this.choosedArea.title        }else{          this.deviceArea ="选择区域"        }      }    },    methods:{      /*删除设备的分享*/      delAssignDevices(it){        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        const _this =this;        let data = {          sn:it.sn,          sharedUserId:this.operateUserInfo.userId,          deviceName:it.deviceName,          userId:userId,          type:1,          loginType:2,          accessToken:accessToken,          permissions:permissions        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/shared/deleteMySharedDevice",          data        },(res)=>{          if(res.data.code==0){            this.queryShareMeDevice(0)            this.$Message.success(_this.lang.delSuccess);          }else{            this.$Message.success(res.data.msg)          }        },(erro)=>{          console.log(erro);        })      },      /*分配设备*/      assignDevices(it){        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        const _this = this;        let data = {          sn:it.sn,          sharedUserId:this.operateUserInfo.userId,          deviceName:it.deviceName,          userId:userId,          loginType:2,          accessToken:accessToken,          permissions:permissions        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/userAssigned/addAssignedDevices",          data        },(res)=>{          if(res.data.code==0){            this.queryShareMeDevice(0)            this.$Message.success(_this.lang.success)          }else{            this.$Message.success(res.data.msg)          }        },(erro)=>{          console.log(erro);        })      },      shareDevice(){        this.queryShareMeDevice(0)        this.shareDeviceModal = true;      },      userListChange(it){        this.userListPageNow = it-1;        this.selectUserAssigned(it-1)      },      deviceListPageChange(it){        this.deviceListPageNow = it-1;        this.queryShareMeDevice(it-1)      },      queryShareMeDevice(page){        this.deviceListPageNow = page;        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        let data = {          regionalId:this.choosedArea.regionalId,          rows:10,          page:page,          sharedUserId:this.operateUserInfo.userId,          deviceName:this.deviceName,          userId:userId,          loginType:2,          accessToken:accessToken,          permissions:permissions        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/userAssigned/selectAssignedDevices",          data        },(res)=>{          if(res.data.code==0){            let result = res.data;            this.deviceList = result.data.dataList;            this.deviceListPage = result.data.count;          }else{            this.$Message.success(res.data.msg)          }        },(erro)=>{          console.log(erro);        })      },      confirmChooseArea(){        this.deviceAreaModal = false;        this.shareDeviceModal = true;        this.choosedArea = this.choosedAreaTemp;      },      chooseToTheArea(it){        this.choosedAreaTemp = it[0]      },      /*获取区域树*/      getDeviceArea(){        this.deviceArea = {};        this.choosedAreaTemp = {};        this.allAreaListTemp = [];        this.allAreaList = [];        this.shareDeviceModal = false        this.deviceAreaModal = true;        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        let data ={          type:0 ,          userId:userId,          accessToken:accessToken,          permissions:permissions*1 ,          loginType:2        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/regional/getRegional",          data        },(res)=>{          let result = res.data.data;          let list = {};          let resultHandle = [];          result.forEach(function(val,index){            list = {              title:val.regionalName,              regionalId:val.regionalId,              upRegionalId:val.upRegionalId,              children:[]            };            val.childRegional.forEach(function(value,i){              list.children.push({                title:value.regionalName,                regionalId:value.regionalId,                upRegionalId:value.upRegionalId              })            })            resultHandle.push(list)          });          this.allAreaList = resultHandle;        },(erro)=>{          console.log(erro)        })      },      /*重置账号密码*/      resetAccountPsd(){        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        let data = {          sharedUserId:this.operateUserInfo.userId,          userId:userId,          loginType:2,          accessToken:accessToken,          permissions:permissions        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/userAssigned/updateUserAssigned",          data        },(res)=>{         if(res.data.code==0){           this.confirmModal = false;           this.$Message.success('重置密码成功！重置后密码为：123456');         }        },(erro)=>{          console.log(erro);        })      },      /*删除账号*/      delUser(){        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        const _this = this;        let data = {          sharedUserId:this.operateUserInfo.userId,          userId:userId,          loginType:2,          accessToken:accessToken,          permissions:permissions        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/userAssigned/deleteUserAssigned",          data        },(res)=>{          this.confirmModal = false;          if(res.data.code==0){            this.$Message.success(_this.lang.delSuccess);            this.selectUserAssigned(0)          }else{            this.$Message.success(res.data.msg);          }        },(erro)=>{          console.log(erro);        })      },      /*确认删除或者重置密码*/      comfirmOperate(){        if(this.theOperate==0){            this.resetAccountPsd()        }else if(this.theOperate==1){            this.delUser()        }      },      /*添加用户*/      comfirmAdd(name){        const _this = this;        this.$refs[name].validate((valid) => {          if (valid) {            let userId = this.$cookie.get('userId');            let accessToken = this.$cookie.get('accessToken');            let permissions = this.$cookie.get('permissions');            let data = {              sharedAccount:this.formInline.account,              pwd:this.formInline.psd,              name:this.formInline.userName,              userId:userId,              loginType:2,              accessToken:accessToken,              permissions:permissions            };            this.$http({              method:'post',              url:this.$util.ajaxUrl+"/userAssigned/addUserAssigned",              data            },(res)=>{              let result = res.data;              if(result.code==0){                this.addUserModal = false;                this.$Message.success(_this.lang.success);                this.selectUserAssigned(0)              }else if(result.code == 109){                this.$Message.error(result.msg);              }            },(erro)=>{              // this.$Message.error("请先完善表单信息！");            })          } else {            this.$Message.error(_this.lang.completeForm);          }        })      },      /*查询子用户*/      selectUserAssigned(page){        this.userListPageNow = page;        let userId = this.$cookie.get('userId');        let accessToken = this.$cookie.get('accessToken');        let permissions = this.$cookie.get('permissions');        let data = {          rows:15,          page:page,          userId:userId,          loginType:2,          accessToken:accessToken,          permissions:permissions        };        this.$http({          method:'post',          url:this.$util.ajaxUrl+"/userAssigned/selectUserAssigned",          data        },(res)=>{          let result = res.data.data;          this.userList = result.dataList;          this.userListPage = result.count;        },(erro)=>{          console.log(erro);        })      }    }  };</script>